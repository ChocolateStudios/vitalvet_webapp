---
// import BaseCombobox from "@/contexts/_shared/client/presentation/components/(old)base-combobox.component.astro";
import DynamicInput from "@/contexts/_shared/client/presentation/components/inputs/dynamic-input.component.astro";
import { viewOptions } from "@/contexts/calendar/client/presentation/components/calendar/calendar-constants";

---

<div id="view-switcher-wrapper" class="w-48">
    <DynamicInput
        id="calendar-view-switcher"
        type="combobox"
        name="calendar_view"
        label="Vista"
        options={viewOptions}
        editable={false}
    />
</div>

<script>
    import { viewOptions } from "@/contexts/calendar/client/presentation/components/calendar/calendar-constants";

    function initializePageScripts() {
        const wrapper = document.getElementById('view-switcher-wrapper');
        if (!wrapper || wrapper.dataset.initialized) return;
        wrapper.dataset.initialized = 'true';

        const combobox = wrapper.querySelector('.combobox-container');
        const hiddenInput = combobox?.querySelector('input[type="hidden"]') as HTMLInputElement | null;
        const comboboxInstance = window.comboboxInstances?.['calendar-view-switcher'];

        if (!hiddenInput || !comboboxInstance) return;

        // 1. Establecer el valor inicial desde localStorage o por defecto
        const savedView = localStorage.getItem('calendar_view') || 'week';
        const initialOption = viewOptions.find(opt => opt.id === savedView);
        if (initialOption) {
            // Usamos el método de la instancia para seleccionar la opción inicial
            // Esto asegura que tanto el input visible como el oculto se actualicen
            comboboxInstance.addOptionAndSelect(initialOption);
        }

        // 2. Escuchar cambios y actuar
        const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                    const newView = hiddenInput.value;
                    
                    // Guardar en localStorage
                    localStorage.setItem('calendar_view', newView);

                    // Despachar evento para que el componente padre reaccione
                    const event = new CustomEvent('view-change', { 
                        bubbles: true, // Permitir que el evento suba por el DOM
                        composed: true, // Permitir que cruce los límites del Shadow DOM (si aplica)
                        detail: { view: newView }
                    });
                    wrapper.dispatchEvent(event);
                }
            }
        });

        observer.observe(hiddenInput, { attributes: true });
    }

    /************************************
     ***** Run scripts on page load *****
    *************************************/
    document.addEventListener('astro:page-load', () => {
        initializePageScripts();
    });
</script>