---
import type { EventListItemInfo } from "@/contexts/calendar/server/application/usecases/getall-events.usecase";

const { data } = Astro.props;
const { selectedDate, events } = data;

const daysOfWeekNames = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];

const current = new Date(selectedDate);
const threeDays = Array.from({ length: 3 }, (_, i) => {
    const day = new Date(current);
    day.setDate(current.getDate() + i);
    const dateString = day.toISOString().split('T')[0];
    return {
        date: day,
        name: daysOfWeekNames[day.getDay()],
        isToday: day.toDateString() === new Date().toDateString(),
        events: events.filter((e: EventListItemInfo) => e.startDateTime.toISOString().split('T')[0] === dateString)
    };
});

const timeSlots = Array.from({ length: 24 }, (_, i) => `${i}:00`);
---

<div class="border rounded-lg">
    <div class="grid grid-cols-[auto_1fr]">
        <!-- Eje de Tiempo -->
        <div class="col-start-1 row-start-2 border-r">
            {timeSlots.map(time => (
                <div class="h-16 text-right pr-2 text-xs text-gray-500 border-t">{time}</div>
            ))}
        </div>

        <!-- Cuadrícula de la Vista -->
        <div class="col-start-2 row-start-2 grid grid-cols-3">
            {threeDays.map(day => (
                <div class="border-l">
                    {timeSlots.map((time, index) => (
                        <div class="h-16 border-t"></div>
                    ))}
                </div>
            ))}
        </div>

        <!-- Encabezado de Días -->
        <div class="col-start-2 row-start-1 grid grid-cols-3 text-center font-semibold text-sm sticky top-0 bg-white z-10 shadow-sm">
            {threeDays.map(day => (
                <div class:list={["py-2 border-l", { "bg-blue-100": day.isToday }]}>
                    <div>{day.name}</div>
                    <div class:list={["text-lg", { "text-blue-600": day.isToday }]}>{day.date.getDate()}</div>
                </div>
            ))}
        </div>

        <!-- Contenedor de Eventos -->
        <div class="col-start-2 row-start-2 grid grid-cols-3 relative">
            {threeDays.map((day, dayIndex) => (
                <div class="relative">
                    {day.events.map((event: EventListItemInfo) => {
                        const startHour = event.startDateTime.getHours();
                        const duration = 1; // Asumimos 1 hora de duración
                        const top = (startHour - 8) * 4; // 4rem (h-16) por hora, desde las 8am
                        const height = duration * 4;
                        return (
                            <div
                                class="absolute w-full p-1"
                                style={{ top: `${top}rem`, height: `${height}rem` }}
                            >
                                <a href={`/app/calendar/events/${event.id}`} class="bg-blue-200 text-blue-900 text-xs rounded-lg p-1 h-full overflow-hidden block cursor-pointer">
                                    {event.title}
                                </a>
                            </div>
                        )
                    })}
                </div>
            ))}
        </div>
    </div>
</div>
