---
import SearchBar from "../components/search-bar.component.astro";
import { getAllPets } from "../../usecases/getall-pets.usecase";

const pets = getAllPets();

---

<div class="p-4 sm:p-6 lg:p-8">
    <div class="sm:flex sm:justify-between sm:items-center">
        <h2 class="text-2xl font-bold leading-6 text-gray-900">Mascotas</h2>
        <div class="flex gap-4">
            <SearchBar id="pet-search" name="pet-search" placeholder="Buscar por nombre..." />
            <button type="button" class="block rounded-md bg-blue-900 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-blue-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-800">
                Añadir Mascota
            </button>
        </div>
    </div>
    <div class="mt-8 flow-root">
        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                <table id="pets-table" class="min-w-full divide-y divide-gray-300">
                    <thead>
                        <tr>
                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Nombre (edad)</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Especie</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Última visualización</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Número de citas</th>
                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0">
                                <span class="sr-only">Editar</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {
                            pets.map(pet => 
                                <tr class="relative hover:bg-gray-50 cursor-pointer">
                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
                                        <a href={`/app/pets/${pet.id}`} class="before:absolute before:inset-0" aria-label={`Ver detalles de ${pet.name}`}>
                                            <span class="relative z-10">{pet.name} ({pet.age})</span>
                                        </a>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{pet.species}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{pet.lastVisit}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{pet.appointmentCount}</td>
                                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                                        <a href={`/app/pets/${pet.id}/edit`} class="text-blue-800 hover:text-blue-900 relative z-10">Editar<span class="sr-only">, {pet.name}</span></a>
                                    </td>
                                </tr>
                            )
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const searchInput = document.getElementById("pet-search") as HTMLInputElement;
    const table = document.getElementById('pets-table');
    const tableRows = table?.querySelectorAll('tbody tr');

    if (searchInput && tableRows) {
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();

            tableRows.forEach(row => {
                const nameCell = row.querySelector('td:first-child');
                const name = nameCell?.textContent?.toLowerCase() || '';

                if (name.includes(searchTerm)) {
                    (row as HTMLElement).style.display = '';
                } else {
                    (row as HTMLElement).style.display = 'none';
                }
            });
        });
    }
</script>