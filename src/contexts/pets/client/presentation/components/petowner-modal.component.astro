---
import ActionButton from "@/contexts/_shared/client/presentation/components/actions/action-button.component.astro";
import BaseModal from "@/contexts/_shared/client/presentation/components/modals/base-modal.component.astro";
import SimpleForm from "@/contexts/_shared/client/presentation/components/forms/simple-form.component.astro";
import DynamicInput from "@/contexts/_shared/client/presentation/components/inputs/dynamic-input.component.astro";

const ownerRoleId = import.meta.env.OWNER_ROLE_ID;

const profileInputs = [
    {
        id: "owner-name",
        name: "name",
        type: "text",
        autocomplete: "name",
        label: "Nombres",
        validations: [
            { validate: ((value: any) => !!value).toString(), message: 'El nombre es obligatorio' },
            { validate: ((value: any) => value.length >= 3).toString(), message: 'El nombre debe tener al menos 3 caracteres' }
        ],
    },
    {
        id: "owner-lastname",
        name: "lastname",
        type: "text",
        autocomplete: "lastname",
        label: "Apellidos",
        validations: [
            { validate: ((value: any) => !!value).toString(), message: 'El apellido es obligatorio' },
            { validate: ((value: any) => value.length >= 3).toString(), message: 'El apellido debe tener al menos 3 caracteres' }
        ],
    },
    {
        id: "owner-birthday",
        name: "birthday",
        type: "date",
        autocomplete: "birthday",
        label: "Fecha de nacimiento",
        validations: [
            { validate: ((value: any) => !!value).toString(), message: 'La fecha de nacimiento es obligatoria' }
        ],
    },
    {
        id: "owner-email",
        name: "email",
        type: "email",
        autocomplete: "email",
        label: "Correo electrónico",
        validations: [
            { validate: ((value: any) => !!value).toString(), message: 'El correo es obligatorio' },
            { validate: ((value: any) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)).toString(), message: 'Por favor, introduce un correo válido' }
        ],
    },
    {
        id: "owner-phone",
        name: "phone",
        type: "text",
        autocomplete: "phone",
        label: "Teléfono",
        validations: [
            { validate: ((value: any) => !!value).toString(), message: 'El teléfono es obligatorio' }
        ],
    },
    {
        id: "owner-role",
        name: "role",
        type: "text",
        autocomplete: "role",
        label: "Rol",
        value: "Dueño",
        readonly: true,
    },
]
---
<BaseModal id="petowner-modal" title="Agregar nuevo dueño">

    <!-- ------------------
    ------ Main form ------
    ------------------- -->
    <SimpleForm id="owner-form" slot="body" dataset={ownerRoleId}>
        {
            profileInputs.map(input => 
                <DynamicInput {...input} />
            )
        }
    </SimpleForm>
    
    <!-- -----------------------
    ------ Action buttons ------
    ------------------------ -->
    <ActionButton id="owner-submit-button" style="submit" slot="footer">
        Crear dueño
    </ActionButton>
    <ActionButton dataModalClose slot="footer">
        Cancelar
    </ActionButton>
</BaseModal>

<script>
    import { SaveProfileResource } from "@/contexts/profiles/server/interfaces/api/resources/save-profile.resource";
    import { createProfile } from "@/contexts/profiles/client/usecases/create-profile.usecase";

    function initializeForm() {
        const form = document.getElementById('owner-form') as HTMLFormElement | null;
        if (!form) return;
        
        /************************
         ***** Submit event *****
        *************************/
        // Before this event, in base-form.astro validations were executed
        form.addEventListener('form:submit', async (event: any) => {
            const { data, submitButton, isEditMode, formDataObj, formError } = event.detail;
        
            /*********************************
             ***** Prepare for api calls *****
            *********************************/
            submitButton.disabled = true;
            submitButton.textContent = !isEditMode ? 'Creando dueño...'  : 'Actualizando dueño...';
                
        
            /*********************************
             ***** Register/update Owner *****
            *********************************/
            const ownerResource = new SaveProfileResource(data.name, data.lastname, data.email, data.phone, new Date(data.birthday), formDataObj.ownerRoleId!);
            const actionMessage = !isEditMode ? 'crear' : 'actualizar';
            const badErrorMessage = `Error al ${actionMessage} dueño. Por favor, inténtalo de nuevo.`;

            try {
                const response = !isEditMode ? await createProfile(ownerResource) 
                                            : { success: false, errorMessage: badErrorMessage }  //await updatePet(formDataObj.petId!, ownerResource);
                formDataObj.profileId = response.data.id;

                if (!response.success) {
                    formError.textContent = response.errorMessage ?? badErrorMessage;
                } else {
                    // 1. Dispara un evento con los datos del nuevo dueño para que la página principal lo escuche
                    document.dispatchEvent(new CustomEvent('owner-created', {
                        detail: { newOwner: response.data }
                    }));

                    // 2. Dispara un evento para cerrar este modal específico
                    document.dispatchEvent(new CustomEvent('close-modal-by-id', {
                        detail: { id: 'petowner-modal' }
                    }));

                    // 3. Limpia el formulario para la próxima vez
                    form.reset();
                    // [nameInput, lastnameInput, birthdayInput, emailInput, phoneInput].forEach(clearError);
                }
            } catch (error) {
                console.error(`Error al ${actionMessage} dueño:`, error);
                formError.textContent = badErrorMessage;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = !isEditMode ? 'Crear dueño' : 'Guardar cambios';
            }
        });
    }

    /************************************
     ***** Run scripts on page load *****
    *************************************/
    document.addEventListener('astro:page-load', initializeForm);

</script>