---
import BaseModal from "@/contexts/_shared/client/presentation/components/base-modal.component.astro";
import BaseTextInput from "@/contexts/_shared/client/presentation/components/base-text-input.component.astro";

const ownerRoleId = import.meta.env.OWNER_ROLE_ID;

const profileInputs = [
    {
        id: "owner-name",
        name: "name",
        type: "text",
        autocomplete: "name",
        label: "Nombres",
        // value: profile?.name,
    },
    {
        id: "owner-lastname",
        name: "lastname",
        type: "text",
        autocomplete: "lastname",
        label: "Apellidos",
        // value: profile?.lastname,
    },
    {
        id: "owner-birthday",
        name: "birthday",
        type: "date",
        autocomplete: "birthday",
        label: "Fecha de nacimiento",
        // value: profile?.birthday ? (new Date(profile.birthday)).toISOString().split('T')[0] : "",
    },
    {
        id: "owner-email",
        name: "email",
        type: "email",
        autocomplete: "email",
        label: "Correo electrónico",
        // value: profile?.email,
    },
    {
        id: "owner-phone",
        name: "phone",
        type: "text",
        autocomplete: "phone",
        label: "Teléfono",
        // value: profile?.phone,
    },
    {
        id: "owner-role",
        name: "role",
        type: "text",
        autocomplete: "role",
        label: "Rol",
        value: "Dueño",
        readonly: true,
    },
]
---
<BaseModal id="petowner-modal" title="Agregar nuevo dueño">
    <form slot="body" id="owner-form" data-owner-role-id={ownerRoleId} novalidate>
        {
            profileInputs.map(input => 
                <BaseTextInput {...input} />
            )
        }
    </form>
    <div slot="footer">
        <button id='owner-submit-button' type="button" class="inline-flex w-full justify-center rounded-md bg-[#6faab5] px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-[#5f9ea8] sm:w-auto">Agregar dueño</button>
        <button type="button" data-modal-close class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancelar</button>
    </div>
</BaseModal>

<script>
    import { SaveProfileResource } from "@/contexts/profiles/server/interfaces/api/resources/save-profile.resource";
    // import { updateProfile } from "@/contexts/profiles/client/usecases/update-profile.usecase";
    import { createProfile } from "@/contexts/profiles/client/usecases/create-profile.usecase";

    function initializePageScripts() {
        const form = document.getElementById('owner-form') as HTMLFormElement | null;

        if (form) {
            const nameInput = document.getElementById('owner-name') as HTMLInputElement;
            const lastnameInput = document.getElementById('owner-lastname') as HTMLInputElement;
            const birthdayInput = document.getElementById('owner-birthday') as HTMLInputElement;
            const emailInput = document.getElementById('owner-email') as HTMLInputElement;
            const phoneInput = document.getElementById('owner-phone') as HTMLInputElement;
            const submitButton = document.getElementById('owner-submit-button') as HTMLButtonElement;
            const formError = document.getElementById('owner-form-error') as HTMLDivElement;

            // Habilita el botón de envío una vez que el script se ha cargado.
            if (submitButton) {
                submitButton.disabled = false;
            }

            // const isNewOwner = !form.dataset.profileId;
            const isNewOwner = true;

            const showError = (input: HTMLInputElement, message: string) => {
                const errorContainer = document.getElementById(`${input.id}-error-container`);
                if (errorContainer) {
                    errorContainer.textContent = message;
                }
                // Cambia el color del borde del input a rojo
                input.classList.remove('outline-gray-300', 'focus:outline-blue-800');
                input.classList.add('outline-red-500', 'focus:outline-red-500');
            }

            const clearError = (input: HTMLInputElement) => {
                const errorContainer = document.getElementById(`${input.id}-error-container`);
                if (errorContainer) {
                    errorContainer.textContent = '';
                }
                // Restaura el color del borde del input
                input.classList.remove('outline-red-500', 'focus:outline-red-500');
                input.classList.add('outline-gray-300', 'focus:outline-blue-800');
            }

            // form.addEventListener('submit', async (event) => {
            submitButton.addEventListener('click', async (event) => {
                console.log('clicked')
                event.preventDefault();

                // Limpia errores previos
                clearError(nameInput);
                clearError(lastnameInput);
                clearError(birthdayInput);
                clearError(emailInput);
                clearError(phoneInput);
                if (formError) {
                    formError.textContent = '';
                }

                const name = nameInput.value;
                const lastname = lastnameInput.value;
                const birthday = birthdayInput.value;
                const email = emailInput.value;
                const phone = phoneInput.value;

                let isValid = true;

                // Validaciones
                if (!name) {
                    showError(nameInput, 'El nombre es obligatorio');
                    isValid = false;
                } else if (name.length < 3) {
                    showError(nameInput, 'El nombre debe tener al menos 3 caracteres');
                    isValid = false;
                }
                
                if (!lastname) {
                    showError(lastnameInput, 'El apellido es obligatorio');
                    isValid = false;
                } else if (lastname.length < 3) {
                    showError(lastnameInput, 'El apellido debe tener al menos 3 caracteres');
                    isValid = false;
                }

                if (!birthday) {
                    showError(birthdayInput, 'La fecha de nacimiento es obligatoria');
                    isValid = false;
                }

                if (!email) {
                    showError(emailInput, 'El correo es obligatorio');
                    isValid = false;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showError(emailInput, 'Por favor, introduce un correo válido');
                    isValid = false;
                }

                if (!phone) {
                    showError(phoneInput, 'El teléfono es obligatoria');
                    isValid = false;
                }

                if (isValid) {
                    submitButton.disabled = true;
                    
                    const resource = new SaveProfileResource(name, lastname, form.dataset.ownerRoleId!, phone, new Date(birthday));

                    if (isNewOwner) {
                        submitButton.textContent = 'Agregando dueño...';

                        try {
                            const response = await createProfile(resource);
                            if (response.success && response.data) {
                                // 1. Dispara un evento con los datos del nuevo dueño para que la página principal lo escuche
                                document.dispatchEvent(new CustomEvent('owner-created', {
                                    detail: { newOwner: response.data }
                                }));

                                // 2. Dispara un evento para cerrar este modal específico
                                document.dispatchEvent(new CustomEvent('close-modal-by-id', {
                                    detail: { id: 'petowner-modal' }
                                }));

                                // 3. Limpia el formulario para la próxima vez
                                form.reset();
                                [nameInput, lastnameInput, birthdayInput, emailInput, phoneInput].forEach(clearError);

                            } else {
                                formError.textContent = response.errorMessage ?? 'Error al agregar dueño. Por favor, inténtalo de nuevo.';
                            }
                        } catch (error) {
                            console.error('Error al agregar dueño:', error);
                            formError.textContent = 'Error al agregar dueño. Por favor, inténtalo de nuevo.';
                        } finally {
                            submitButton.disabled = false;
                            submitButton.textContent = 'Agregar dueño';
                        }
                    } else {
                        submitButton.textContent = 'Actualizando dueño...';
                        // TODO
                        // try {
                        //     const response = await updateProfile(profileId, resource);
                        //     if (response.success) {
                        //         // window.location.reload();
                        //         // window.location.href = '/app/home';
                        //         // TODO: close modal
                        //     } else {
                        //         formError.textContent = response.errorMessage ?? 'Error al actualizar el dueño. Por favor, inténtalo de nuevo.';
                        //     }
                        // } catch (error) {
                        //     console.error('Error al actualizar el dueño:', error);
                        //     formError.textContent = 'Error al actualizar el dueño. Por favor, inténtalo de nuevo.';
                        // } finally {
                        //     submitButton.disabled = false;
                        //     submitButton.textContent = 'Guardar cambios';
                        // }
                    }
                }
            });
        }
    }

    // Ejecuta los scripts en la carga inicial de la página (con View Transitions) 
    // y en cada navegación del lado del cliente.
    document.addEventListener('astro:page-load', initializePageScripts);

</script>