---
import ContentContainer from "@/contexts/_shared/client/presentation/components/content/content-container.component.astro";
import DynamicInput from "@/contexts/_shared/client/presentation/components/inputs/dynamic-input.component.astro";
import DeletePetMedicalAppointmentDialog from "@/contexts/medical_histories/client/presentation/components/delete-pet-medical-appointment-dialog.component.astro";
import { getMedicalAppointment, type MedicalAppointmentInfo } from "@/contexts/medical_histories/server/application/usecases/get-medicalappointment.usecase";
import { getPet } from "@/contexts/pets/server/application/usecases/get-pet.usecase";
import { getAllProfilesByRoleId } from "@/contexts/profiles/server/application/usecases/get-all-profiles-by-role-id.usecase";
import { getAuthenticatedUserIdOrRedirect } from "@/contexts/_shared/server/application/usecases/get-authenticated-user-or-redirect";
import ActionButton from "@/contexts/_shared/client/presentation/components/actions/action-button.component.astro";
import ContentTop from "@/contexts/_shared/client/presentation/components/content/content-top.component.astro";
import GridForm from "@/contexts/_shared/client/presentation/components/forms/grid-form.component.astro";
import PetMiniprofileCard from "@/contexts/pets/client/presentation/components/pet-miniprofile-card.component.astro";
import SimpleCard from "@/contexts/_shared/client/presentation/components/cards/simple-card.component.astro";
import DocumentsTable from "@/contexts/_shared/client/presentation/components/tables/documents-table.component.astro";
import { getFilesByMedicalAppointment } from "@/contexts/files/server/application/usecases/get-files-by-medical-appointment.usecase";
import type { FilePerEntityResource } from "@/contexts/files/server/interfaces/api/resources/file-per-entity.resource";
import type { PetExtendedResource } from "@/contexts/pets/server/interfaces/api/resources/pet.resource";

/*******************************
 ***** User authentication *****
 ********************************/
// Probably never redirect from here because it would do so from the middleware
const authenticatedUserId = await getAuthenticatedUserIdOrRedirect(Astro);

/****************************
 ***** Page paramenters *****
 *****************************/
const { petId, medicalAppointmentId } = Astro.props;

/************************************
 ***** Get info to show on page *****
 *************************************/
let pet: PetExtendedResource | null = null;
let medicalAppointment: MedicalAppointmentInfo | null = null;
let doctorProfiles: any[] = [];
let existingDocuments: FilePerEntityResource[] = [];

const getPetResult = await getPet(petId);
if (getPetResult.success) {
    pet = getPetResult.data ?? null;
}

const getMedicalAppointmentResult = await getMedicalAppointment(
    petId,
    medicalAppointmentId,
);
if (getMedicalAppointmentResult.data) {
    medicalAppointment = getMedicalAppointmentResult.data ?? null;
}

const getDoctorProfilesResult = await getAllProfilesByRoleId(
    import.meta.env.VETERINARIAN_ROLE_ID,
    authenticatedUserId,
);
if (getDoctorProfilesResult.success) {
    doctorProfiles = getDoctorProfilesResult.data;
    doctorProfiles = doctorProfiles.map((dp) => ({
        id: dp.id,
        name: `${dp.name} ${dp.lastname} ${dp.me ? "(T√∫)" : ""}`,
        me: dp.me,
    }));
}

const getDocumentsResult = await getFilesByMedicalAppointment(
    petId,
    medicalAppointmentId,
);
if (getDocumentsResult.success && getDocumentsResult.data) {
    existingDocuments = getDocumentsResult.data;
}

// Format documents for table
const documentItems = existingDocuments.map((doc) => ({
    id: doc.id.toString(),
    fileName: doc.fileName,
    fileUrl: doc.fileUrl,
    isExisting: true,
}));

/***********************
 ***** Form inputs *****
 ************************/
const medicalAppointmentInfoInputs = [
    {
        id: "doctor",
        name: "doctor",
        type: "combobox",
        label: "Veterinario",
        value: medicalAppointment
            ? medicalAppointment?.doctorProfileId.toString()
            : doctorProfiles && doctorProfiles.length > 0
              ? doctorProfiles.find((dp) => dp.me === true)?.id.toString()
              : "",
        options: doctorProfiles ?? [],
        validations: [
            {
                validate: ((value: any) => !!value).toString(),
                message: "El veterinario es obligatorio",
            },
        ],
        showMandatory: true,
    },
];

const medicalAppointmentInputs = [
    {
        id: "weight",
        name: "weight",
        type: "number",
        autocomplete: "weight",
        label: "Peso (kg)",
        value: medicalAppointment?.weight,
        validations: [
            {
                validate: ((value: any) => !!value).toString(),
                message: "El peso es obligatorio",
            },
            {
                validate: ((value: any) => !isNaN(Number(value))).toString(),
                message: "El peso debe ser un n√∫mero",
            },
            {
                validate: ((value: any) => Number(value) > 0).toString(),
                message: "El peso debe ser mayor a 0",
            },
        ],
        showMandatory: true,
    },
    {
        id: "date",
        name: "date",
        type: "date",
        autocomplete: "appointmentDate",
        label: "Fecha de la cita",
        value: medicalAppointment
            ? medicalAppointment.appointmentDate
                ? new Date(medicalAppointment.appointmentDate)
                      .toISOString()
                      .split("T")[0]
                : ""
            : new Date().toISOString().split("T")[0],
        validations: [
            {
                validate: ((value: any) => !!value).toString(),
                message: "La fecha de la cita es obligatoria",
            },
        ],
        showMandatory: true,
    },
    {
        id: "observations",
        name: "observations",
        label: "Observaciones",
        type: "textarea",
        value: medicalAppointment?.observations,
        validations: [
            {
                validate: ((value: any) => !!value).toString(),
                message: "Las observaciones son obligatorias",
            },
        ],
        showMandatory: true,
        class: "col-span-full",
    },
    {
        id: "prescription",
        name: "prescription",
        label: "Receta / Tratamiento",
        type: "textarea",
        value: medicalAppointment?.prescription,
        validations: [
            {
                validate: ((value: any) => !!value).toString(),
                message: "La receta/tratamiento es obligatoria",
            },
        ],
        showMandatory: true,
        class: "col-span-full",
    },
];
---

<ContentContainer>
    <!-- ----------------
    ------ Top bar ------
    ----------------- -->
    <ContentTop backHref={`/app/pets/${petId}/medical-history`}>
        {
            // Main Title
            medicalAppointment
                ? `Cita m√©dica N¬∞ ${medicalAppointment?.appointmentNumber}`
                : "Nueva cita m√©dica"
        }
    </ContentTop>

    <!-- ------------------
    ------ Main form ------
    ------------------- -->
    <!-- (Important to set editMode) -->
    <GridForm
        id="medicalappointment-form"
        editMode={!!medicalAppointment}
        lgCols={6}
        dataset={{
            petId: pet?.id,
            medicalAppointmentId: medicalAppointment?.id,
        }}
    >
        <!-- Left Side -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- ----------------------------------
            ------ üê∂ Pet mini profiled card ------
            ----------------------------------- -->
            <PetMiniprofileCard pet={pet} />
            <div class="bg-white rounded-xl shadow-lg p-7 text-left">
                <h3 class="font-semibold mb-3">Informaci√≥n de la cita</h3>
                <div class="flex flex-col items-center w-full">
                    {
                        medicalAppointmentInfoInputs.map((infoInput) => (
                            <DynamicInput {...infoInput} />
                        ))
                    }
                </div>
            </div>
        </div>

        <div
            class="col-span-4 flex flex-col gap-6 max-h-[calc(100vh-18rem)] overflow-y-auto pr-2"
        >
            <!-- -----------------------
            ------ Details card ------
            ------------------------ -->
            <SimpleCard>
                <h4 class="mb-4">Detalles de la cita</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1">
                    {
                        medicalAppointmentInputs.map((input) => (
                            <DynamicInput {...input} />
                        ))
                    }
                </div>
            </SimpleCard>

            <!-- -----------------------
            ------ Documents card ------
            ------------------------ -->
            <SimpleCard>
                <DocumentsTable id="documents" initialItems={documentItems} />
            </SimpleCard>
        </div>

        <!-- -----------------------
        ------ Action buttons ------
        ------------------------ -->
        <div
            class="col-span-full flex sm:flex-wrap sm:flex-row sm:justify-end mt-7 gap-4"
        >
            <ActionButton id="submit-button" type="submit" disabled>
                {medicalAppointment ? "Guardar cambios" : "Crear cita m√©dica"}
            </ActionButton>
            {
                medicalAppointment && (
                    <>
                        <ActionButton
                            id="open-delete-dialog-button"
                            type="danger"
                        >
                            Eliminar
                        </ActionButton>
                        <DeletePetMedicalAppointmentDialog />
                    </>
                )
            }
        </div>

        <div class="form-error col-span-full text-red-500"></div>
    </GridForm>
</ContentContainer>

<script>
    import { SaveMedicalAppointmentResource } from "@/contexts/medical_histories/server/interfaces/api/resources/save-medical-appointment.resource";
    import { createMedicalAppointment } from "@/contexts/medical_histories/client/services/create-medicalappointment.service";
    import { updateMedicalAppointment } from "@/contexts/medical_histories/client/services/update-medicalappointment.service";
    import { tryCreateEditRequestOrThrowError, validErrorMessage } from "@/contexts/_shared/client/presentation/components/forms/form-utils";
    import { SaveFileResource } from "@/contexts/files/server/interfaces/api/resources/save-file.resource";
    import { uploadMedicalAppointmentDocument } from "@/contexts/medical_histories/client/services/upload-medical-appointment-document.service";
    import { deleteFile } from "@/contexts/files/client/services/delete-file.service";

    const DOCUMENTS_TABLE_ID = "documents";

    function getDocumentsTableManager() {
        return (window as any).DocumentsTableRegistry?.getManager(
            DOCUMENTS_TABLE_ID,
        );
    }

    function enableSubmitButton() {
        const submitButton = document.getElementById("submit-button") as HTMLButtonElement;
        if (submitButton) submitButton.disabled = false;
    }

    async function uploadDocuments(petId: string, medicalAppointmentId: string, formError: HTMLElement) {
        const manager = getDocumentsTableManager();
        if (!manager) return true;

        const pendingItems = manager.getPendingItems();
        if (pendingItems.length === 0) return true;

        const pendingFiles = manager.getPendingFiles();
        let allUploadsSuccessful = true;

        for (const item of pendingItems) {
            const file = pendingFiles.get(item.id);
            if (!file) continue;

            const resource = new SaveFileResource(
                file,
                file.name.split(".").slice(0, -1).join("."),
                file.name.split(".").pop() || "",
                file.type,
                file.size,
            );

            const uploadResult = await uploadMedicalAppointmentDocument(
                petId,
                medicalAppointmentId,
                item.id,
                resource,
            );

            if (!uploadResult.success) {
                formError.textContent =
                    validErrorMessage(uploadResult.errorMessage) ??
                    "Error al subir documento. Por favor, int√©ntalo de nuevo.";
                allUploadsSuccessful = false;
                break;
            }
        }

        if (allUploadsSuccessful) {
            manager.clearPendingFiles();
        }

        return allUploadsSuccessful;
    }

    async function deleteDocuments() {
        const manager = getDocumentsTableManager();
        if (!manager) return true;

        const deletedIds = manager.getDeletedItems();
        if (deletedIds.length === 0) return true;

        let allDeletionsSuccessful = true;

        for (const docId of deletedIds) {
            const deleteResult = await deleteFile(docId);
            if (!deleteResult.success) {
                console.error(
                    `Error deleting document ${docId}:`,
                    deleteResult.errorMessage,
                );
                allDeletionsSuccessful = false;
            }
        }

        return allDeletionsSuccessful;
    }

    function initializeForm() {
        const form = document.getElementById("medicalappointment-form") as HTMLFormElement | null;
        if (!form) return;

        // Listen for table changes to enable submit button
        document.addEventListener(`documents-table:changed:${DOCUMENTS_TABLE_ID}`, () => enableSubmitButton());

        /************************
         ***** Submit event *****
         ************************/
        // Before this event, in base-form.component.astro validations were executed
        form.addEventListener("form:submit", async (event: any) => {
            const { data, submitButton, isEditMode, formDataObj, formError } = event.detail;

            const manager = getDocumentsTableManager();
            const hasDocumentChanges = manager?.hasChanges() ?? false;

            const processDocuments = async () => {
                if (!hasDocumentChanges) return true;

                // Upload new documents
                const uploadSuccess = await uploadDocuments(
                    formDataObj.petId!,
                    formDataObj.medicalAppointmentId!,
                    formError,
                );

                if (!uploadSuccess) return false;

                // Delete marked documents
                const deleteSuccess = await deleteDocuments();

                return uploadSuccess && deleteSuccess;
            };

            // If in edit mode, process documents first
            if (isEditMode) {
                const documentsOk = await processDocuments();
                if (!documentsOk) return;
            }

            const registerOrUpdateMedicalAppointment = async ({ forceUpdate, cancelRedirect }: { forceUpdate?: boolean; cancelRedirect?: boolean } = {}) => {
                const resource = new SaveMedicalAppointmentResource(
                    Number(data.weight),
                    data.observations,
                    data.prescription,
                    new Date(data.date),
                    data.doctor ?? 0,
                );
                const editMode = !!forceUpdate || isEditMode;

                await tryCreateEditRequestOrThrowError({
                    isEditMode,
                    formError,
                    entityDisplayName: "cita m√©dica",
                    submitButton,
                    makeRequestFunc: async () =>
                        !editMode
                            ? await createMedicalAppointment(
                                  formDataObj.petId!,
                                  resource,
                              )
                            : await updateMedicalAppointment(
                                  formDataObj.petId!,
                                  formDataObj.medicalAppointmentId!,
                                  resource,
                              ),
                    onSuccessFunc: (response: any) => {
                        formDataObj.medicalAppointmentId = response.data.id;

                        if (!cancelRedirect)
                            window.location.href = `/app/pets/${formDataObj.petId!}/medical-history`;
                    },
                });
            };

            await registerOrUpdateMedicalAppointment({
                cancelRedirect: !isEditMode,
            });

            // If creating new, process documents after appointment is created
            if (!isEditMode) {
                await processDocuments();
                await registerOrUpdateMedicalAppointment({ forceUpdate: true });
            }
        });
    }

    function initializeDeleteDialog() {
        /*******************************
         ***** Delete dialog logic *****
         ********************************/
        const openDialogButton = document.getElementById(
            "open-delete-dialog-button",
        );
        const dialog = document.getElementById("delete-dialog");
        const toggleDialog = (show: boolean) =>
            dialog?.classList.toggle("hidden", !show);

        openDialogButton?.addEventListener("click", () => toggleDialog(true));
    }

    /************************************
     ***** Run scripts on page load *****
     *************************************/
    document.addEventListener("astro:page-load", () => {
        initializeForm();
        initializeDeleteDialog();
    });
</script>
