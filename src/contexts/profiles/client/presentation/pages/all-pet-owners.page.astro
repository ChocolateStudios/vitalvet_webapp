---
import ContentContainer from "@/contexts/_shared/client/presentation/components/content/content-container.component.astro";
import { getAuthenticatedUserIdOrRedirect } from "@/contexts/_shared/server/application/usecases/get-authenticated-user-or-redirect";
import SearchBar from "@/contexts/_shared/client/presentation/components/inputs/search-bar.component.astro";
import { getAllProfilesByRoleId } from "@/contexts/profiles/server/application/usecases/get-all-profiles-by-role-id.usecase";
import ContentTop from "@/contexts/_shared/client/presentation/components/content/content-top.component.astro";
import ActionLink from "@/contexts/_shared/client/presentation/components/actions/action-link.component.astro";
import SimpleTable from "@/contexts/_shared/client/presentation/components/tables/simple-table.component.astro";
import SimpleCard from "@/contexts/_shared/client/presentation/components/cards/simple-card.component.astro";

/*******************************
 ***** User authentication *****
 ********************************/
// Probably never redirect from here because it would do so from the middleware
const authenticatedUserId = getAuthenticatedUserIdOrRedirect(Astro);

/****************************
 ***** Page paramenters *****
 *****************************/
// NO PARAMETERS HERE

/************************************
 ***** Get info to show on page *****
 *************************************/
let owners = [];
const getOwnersResult = await getAllProfilesByRoleId(
    import.meta.env.OWNER_ROLE_ID,
    authenticatedUserId,
);

if (getOwnersResult.success) {
    owners = getOwnersResult.data ?? [];
}

/*************************
 ***** Table headers *****
 **************************/
const tableHeaders = ["Nombre", "Correo", "Celular", "N° de mascotas"];
---

<ContentContainer>
    <!-- ----------------
    ------ Top bar ------
    ----------------- -->
    <ContentTop>
        Dueños de mascotas <!-- MainTitle -->
        <div slot="right" class="flex gap-4">
            <SearchBar id="owners-search" name="owners-search" />
            <ActionLink href={`/app/owners/newOwner`} style="submit">
                Añadir dueño
            </ActionLink>
        </div>
    </ContentTop>

    <!-- ------------------
    ------ Main card ------
    ------------------- -->
    <SimpleCard class="flow-root">
        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div
                class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8"
            >
                <!-- -------------------
                ------ Main table ------
                -------------------- -->
                <SimpleTable
                    id="owners-table"
                    headers={tableHeaders}
                    items={owners}
                    itemsName="dueños"
                    noItemsMessage="No hay dueños registrados."
                >
                    {
                        owners.map((owner: any) => (
                            <tr class="relative hover:bg-gray-50 cursor-pointer">
                                <td class="whitespace-nowrap px-3 py-4 text-base text-gray-500 font-medium">
                                    <a
                                        href={`/app/owners/${owner.id}`}
                                        class="before:absolute before:inset-0"
                                        aria-label={`Ver detalles de ${owner.name}`}
                                    >
                                        <span class="relative z-10">
                                            {owner.name + " " + owner.lastname}
                                        </span>
                                    </a>
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-base text-gray-500">
                                    {owner.email}
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-base text-gray-500">
                                    {owner.phone}
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-base text-gray-500">
                                    {owner.petsCount}
                                </td>
                            </tr>
                        ))
                    }
                </SimpleTable>
            </div>
        </div>
    </SimpleCard>
</ContentContainer>

<script>
    function initializePageScripts() {
        const searchInput = document.getElementById(
            "owner-search",
        ) as HTMLInputElement;
        const table = document.getElementById("owners-table");
        const tableRows = table?.querySelectorAll("tbody tr");

        const normalizeText = (text: string | null | undefined): string => {
            if (!text) return "";
            return text.toLowerCase().normalize("NFD").replace(/\p{M}/gu, "");
        };

        if (searchInput && tableRows) {
            searchInput.addEventListener("input", () => {
                const searchTerm = normalizeText(searchInput.value);

                tableRows.forEach((row) => {
                    let rowText = "";
                    row.querySelectorAll("td").forEach((cell) => {
                        rowText += normalizeText(cell.textContent);
                    });

                    if (rowText.includes(searchTerm)) {
                        (row as HTMLElement).style.display = "";
                    } else {
                        (row as HTMLElement).style.display = "none";
                    }
                });
            });
        }
    }

    // Ejecuta los scripts en la carga inicial de la página (con View Transitions)
    // y en cada navegación del lado del cliente.
    document.addEventListener("astro:page-load", initializePageScripts);
</script>
